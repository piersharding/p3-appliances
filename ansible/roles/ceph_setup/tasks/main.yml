---
- name: Ensure Ceph package signing key is present
  apt_key:
    url: 'https://git.ceph.com/?p=ceph.git;a=blob_plain;f=keys/release.asc'
    state: present

- name: Add Ceph apt source
  lineinfile:
    line: 'deb http://download.ceph.com/debian-luminous/ xenial main'
    dest: /etc/apt/sources.list.d/ceph.list
    create: yes
    owner: root
    group: root
    mode: 0644

- name: Update apt cache
  apt:
    update_cache: yes

# - name: Ensure Ceph repo package is installed
#   yum:
#     name: https://download.ceph.com/rpm/el7/noarch/ceph-release-1-1.el7.noarch.rpm
#     state: present

- name: Ensure Ceph client packages are installed
  apt:
    name: ceph
    state: latest

- name: Write SoftIron Ceph configuration file
  copy:
    src: softiron-ceph.conf
    dest: /etc/ceph/ceph.conf
    mode: 0644
    owner: root
    group: root

- name: Write Ceph client key
  template: 
    src: ceph.client.keyring.j2
    dest: /etc/ceph/ceph.client.{{ceph_client}}.keyring
    mode: 0600
    owner: root
    group: root

- name: Write Ceph client secret
  template:
    src: ceph.client.secret.j2
    dest: /etc/ceph/ceph.client.{{ceph_client}}.secret
    mode: 0600
    owner: root
    group: root
